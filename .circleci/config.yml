---
version: 2.1

orbs:
    codecov: codecov/codecov@1.1.3

jobs:
    build_and_test:
        docker:
            - image: cimg/python:3.8.0
        steps:
            - checkout
            - restore_cache:
                  keys:
                      - deps-{{ checksum "poetry.lock" }}
            - run:
                  name: Install Dependencies
                  command: poetry install
            - save_cache:
                  key: deps-{{ checksum "poetry.lock" }}
                  paths:
                      - /home/circleci/.cache/pypoetry/virtualenvs
            - run:
                  name: Run pylint
                  command: poetry run pylint src/ tests/
            - run:
                  name: Run black
                  command: poetry run black --check .
            - run:
                  name: Run isort
                  command: poetry run isort .
            - run:
                  name: Run Tests
                  command: poetry run pytest -vv --cov=src --cov-fail-under=70 --cov-report=term --cov-report=xml
            - codecov/upload:
                  file: coverage.xml
            - setup_remote_docker:
                  version: 19.03.13
                  docker_layer_caching: true
            - run:
                  name: Docker Build and Run
                  command: |
                      docker build . -t google-photos-archiver
                      docker run google-photos-archiver

workflows:
    build_and_test:
        jobs:
            - build_and_test
